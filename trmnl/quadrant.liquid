{% comment %}
User base currency (EUR, USD, etc.)
{% endcomment %}
{% assign base = trmnl.plugin_settings.custom_fields_values.base_currency | upcase %}

{% comment %}
User metal unit (troy_ounce, grams)
{% endcomment %}
{% assign metal_unit = trmnl.plugin_settings.custom_fields_values.metal_unit %}

{% comment %}
Currency symbol mapping
{% endcomment %}
{% if base == "USD" %}
  {% assign currency_symbol = "$" %}
{% elsif base == "EUR" %}
  {% assign currency_symbol = "€" %}
{% elsif base == "GBP" %}
  {% assign currency_symbol = "£" %}
{% elsif base == "JPY" or base == "CNY" %}
  {% assign currency_symbol = "¥" %}
{% elsif base == "UAH" %}
  {% assign currency_symbol = "₴" %}
{% elsif base == "INR" %}
  {% assign currency_symbol = "₹" %}
{% elsif base == "ILS" %}
  {% assign currency_symbol = "₪" %}
{% elsif base == "KRW" %}
  {% assign currency_symbol = "₩" %}
{% elsif base == "VND" %}
  {% assign currency_symbol = "₫" %}
{% elsif base == "PHP" %}
  {% assign currency_symbol = "₱" %}
{% elsif base == "RUB" %}
  {% assign currency_symbol = "₽" %}
{% else %}
  {% assign currency_symbol = "" %}
{% endif %}

{% comment %}
Fetch rates
{% endcomment %}
{% assign forex = IDX_0 %}
{% assign metals = IDX_1 %}
{% assign crypto = IDX_2 %}
{% assign stocks = IDX_3 %}

{% comment %}
Collect all symbols from different asset types
{% endcomment %}
{% assign all_symbols = "" | split: "" %}

{% comment %}
Process fiat assets
{% endcomment %}
{% assign fiat_assets_string = trmnl.plugin_settings.custom_fields_values.fiat_assets %}
{% assign fiat_assets = fiat_assets_string | split: ',' %}

{% for symbol in fiat_assets %}
  {% assign symbol = symbol | strip %}
  {% if symbol != "" %}
    {% assign symbol_with_type = symbol | append: ":forex" %}
    {% assign temp_array = symbol_with_type | split: "|" %}
    {% assign all_symbols = temp_array | concat: all_symbols %}
  {% endif %}
{% endfor %}

{% comment %}
Process metal assets
{% endcomment %}
{% assign metal_assets_string = trmnl.plugin_settings.custom_fields_values.metal_assets %}
{% assign metal_assets = metal_assets_string | split: ',' %}

{% for symbol in metal_assets %}
  {% assign symbol = symbol | strip %}
  {% if symbol != "" %}
    {% assign symbol_with_type = symbol | append: ":metal" %}
    {% assign temp_array = symbol_with_type | split: "|" %}
    {% assign all_symbols = temp_array | concat: all_symbols %}
  {% endif %}
{% endfor %}

{% comment %}
Process crypto assets
{% endcomment %}
{% assign crypto_assets_string = trmnl.plugin_settings.custom_fields_values.crypto_assets %}
{% assign crypto_assets = crypto_assets_string | split: ',' %}

{% for symbol in crypto_assets %}
  {% assign symbol = symbol | strip %}
  {% if symbol != "" %}
    {% assign symbol_with_type = symbol | append: ":crypto" %}
    {% assign temp_array = symbol_with_type | split: "|" %}
    {% assign all_symbols = temp_array | concat: all_symbols %}
  {% endif %}
{% endfor %}

{% comment %}
Process stock assets
{% endcomment %}
{% assign stock_assets_string = trmnl.plugin_settings.custom_fields_values.stock_assets %}
{% assign stock_assets = stock_assets_string | split: ',' %}

{% for symbol in stock_assets %}
  {% assign symbol = symbol | strip %}
  {% if symbol != "" %}
    {% assign symbol_with_type = symbol | append: ":stock" %}
    {% assign temp_array = symbol_with_type | split: "|" %}
    {% assign all_symbols = temp_array | concat: all_symbols %}
  {% endif %}
{% endfor %}

{%- comment -%} Build sortable_str with entries separated by a unique token {%- endcomment -%}
{% assign sortable_str = "" %}

{% for symbol_with_type in all_symbols %}
  {% assign parts = symbol_with_type | split: ":" %}
  {% assign symbol = parts[0] %}
  {% assign type = parts[1] %}
  {% assign price = 0 %}

  {% case type %}
    {% when "forex" %}
      {% if forex.rates[symbol] %}
        {% assign price = 1 | divided_by: forex.rates[symbol] %}
      {% endif %}
    {% when "metal" %}
      {% if metals.rates[symbol] %}
        {% assign price = 1 | divided_by: metals.rates[symbol] %}
        {% if metal_unit == "troy_ounce" %}
          {% assign price = price | times: 31.1034768 %}
        {% endif %}
      {% endif %}
    {% when "crypto" %}
      {% if crypto.rates[symbol] %}
        {% assign price = 1 | divided_by: crypto.rates[symbol] %}
      {% endif %}
    {% when "stock" %}
      {% if stocks.rates[symbol] %}
        {% assign price = 1 | divided_by: stocks.rates[symbol] %}
      {% endif %}
  {% endcase %}

  {%- comment -%} zero-pad numeric value (multiply to preserve decimals) {%- endcomment -%}
  {% assign padded_num = price | times: 1000000 | round %}
  {% assign padded = padded_num | prepend: "000000000000" | slice: -12, 12 %}

  {%- comment -%} entry format: padded|SYMBOL|TYPE|RAWPRICE {%- endcomment -%}
  {% assign entry = padded | append: "|" | append: symbol | append: "|" | append: type | append: "|" | append: price %}

  {%- comment -%} append to sortable_str using a separator that won't appear in data {%- endcomment -%}
  {% if sortable_str == "" %}
    {% assign sortable_str = entry %}
  {% else %}
    {% assign sortable_str = sortable_str | append: "§§§" | append: entry %}
  {% endif %}
{% endfor %}

{%- comment -%} turn into a real array and sort by padded prefix (lexicographic), then reverse for DESC {%- endcomment -%}
{% assign sortable = sortable_str | split: "§§§" %}
{% assign sortable = sortable | sort %}
{% assign sortable = sortable | reverse %}

{% comment %}
Determine grid layout based on number of symbols
{% endcomment %}
{% assign symbol_count = all_symbols.size %}

{% if symbol_count == 0 %}
  {% assign grid_class = "grid" %}
{% elsif symbol_count == 1 %}
  {% assign grid_class = "grid grid--cols-1" %}
{% elsif symbol_count == 2 %}
  {% assign grid_class = "grid grid--cols-1" %}
{% elsif symbol_count <= 12 %}
  {% assign grid_class = "grid grid--cols-2" %}
{% else %}
  {% comment %} Limit to 12 symbols maximum {% endcomment %}
  {% assign grid_class = "grid grid--cols-1" %}
  {% assign symbol_count = 12 %}
{% endif %}

<div class="layout layout--col gap--space-between">

  {% if symbol_count == 0 %}
    <div class="grid">
      <div class="item">
        <div class="meta"></div>
        <div class="content">
          <span class="value md:value--large lg:value--xlarge value--tnums">No symbols configured</span>
          <span class="label">Add symbols in plugin settings</span>
        </div>
      </div>
    </div>
  
  {% else %}
    <div class="{{ grid_class }}">
      {% for entry in sortable %}
        {% assign parts = entry | split: "|" %}
        {% assign symbol = parts[1] %}
        {% assign type = parts[2] %}
        {% assign price = parts[3] %}
        
        {% assign price = 0 %}
        
        {% case type %}
          {% when "forex" %}
            {% if forex.rates[symbol] %}
              {% assign price = 1 | divided_by: forex.rates[symbol] %}
            {% endif %}
          {% when "metal" %}
            {% if metals.rates[symbol] %}
              {% assign price = 1 | divided_by: metals.rates[symbol] %}
              {% if metal_unit == "troy_ounce" %}
                {% assign price = price | times: 31.1034768 %}
              {% endif %}
            {% endif %}
          {% when "crypto" %}
            {% if crypto.rates[symbol] %}
              {% assign price = 1 | divided_by: crypto.rates[symbol] %}
            {% endif %}
          {% when "stock" %}
            {% if stocks.rates[symbol] %}
              {% assign price = 1 | divided_by: stocks.rates[symbol] %}
            {% endif %}
        {% endcase %}
        
        <div class="item">
          <div class="meta"></div>
          <div class="content">
            <span class="value {% if symbol_count == 1 %}md:value--large lg:value--xlarge{% elsif symbol_count == 2 %}md:value--large lg:value--xlarge{% elsif symbol_count <= 3 %}md:value lg:value--large{% elsif symbol_count <= 4 %}md:value--small lg:value{% elsif symbol_count <= 8 %}md:value--large lg:value--large{% elsif symbol_count <= 10 %}md:value lg:value--large{% elsif symbol_count <= 12 %}md:value--small lg:value--large{% else %}md:value--large lg:value--xlarge{% endif %} value--tnums" data-value-format="true">
              {{ price | round: 4 | number_to_currency: currency_symbol }}
            </span>
            <span class="label">
              {% case type %}
                {% when "forex" %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-cash"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 9m0 1a1 1 0 0 1 1 -1h12a1 1 0 0 1 1 1v8a1 1 0 0 1 -1 1h-12a1 1 0 0 1 -1 -1z" /><path d="M12 14a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /></svg>
                {% when "metal" %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-medal"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 4v3m-4 -3v6m8 -6v6" /><path d="M12 18.5l-3 1.5l.5 -3.5l-2 -2l3 -.5l1.5 -3l1.5 3l3 .5l-2 2l.5 3.5z" /></svg>
                {% when "crypto" %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-coin-bitcoin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 8h4.09c1.055 0 1.91 .895 1.91 2s-.855 2 -1.91 2c1.055 0 1.91 .895 1.91 2s-.855 2 -1.91 2h-4.09" /><path d="M10 12h4" /><path d="M10 7v10v-9" /><path d="M13 7v1" /><path d="M13 16v1" /></svg>
                {% when "stock" %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chart-line"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 19l16 0" /><path d="M4 15l4 -6l4 2l4 -5l4 4" /></svg>
              {% endcase %}
              {{ symbol }}
            </span>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>