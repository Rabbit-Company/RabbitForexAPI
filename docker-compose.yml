services:
  rabbitforexapi:
    image: rabbitcompany/rabbitforexapi:latest
    container_name: rabbitforexapi
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - WISE_API_KEY
      - UPDATE_INTERVAL
      - TRADING212_API_KEY
      - TRADING212_API_SECRET
      - STOCK_UPDATE_INTERVAL
      - USE_KRAKEN
      - USE_BINANCE
      - USE_GATEIO
      - USE_KUCOIN
      - USE_BINGX
      - USE_BYBIT
      - USE_CRYPTOCOM
      - USE_BITFINEX
      - CRYPTO_UPDATE_INTERVAL
      - ENABLED_CRYPTOS
      - LOGGER_LEVEL
      - PROXY
      - OPEN_METRICS_ENABLED
      - OPEN_METRICS_AUTH_TOKEN
      - HISTORY_ENABLED
      - CLICKHOUSE_HOST
      - CLICKHOUSE_PORT
      - CLICKHOUSE_DATABASE
      - CLICKHOUSE_USERNAME
      - CLICKHOUSE_PASSWORD
      - CLICKHOUSE_COMPRESSION
      - CLICKHOUSE_MAX_CONNECTIONS
      - CLICKHOUSE_TIMEOUT
    networks:
      - internal-network
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  clickhouse:
    image: clickhouse/clickhouse-server:latest-alpine
    container_name: rabbitforexapi-clickhouse
    restart: unless-stopped
    expose:
      - "8123"
      - "9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      # This makes ClickHouse consume less resources, which is useful for small setups.
      # https://clickhouse.com/docs/en/operations/tips#using-less-than-16gb-of-ram
      - ./clickhouse/low-resources.xml:/etc/clickhouse-server/config.d/low-resources.xml:ro
    environment:
      - CLICKHOUSE_DB=rabbitforex
      - CLICKHOUSE_USER=rabbitforex_user
      - CLICKHOUSE_PASSWORD=rabbitforex_password
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    networks:
      - internal-network
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--user", "rabbitforex_user", "--password", "rabbitforex_password", "--host", "localhost", "--query", "SELECT 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

networks:
  internal-network:
    driver: bridge

volumes:
  clickhouse_data:
    driver: local
